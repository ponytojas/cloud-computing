---
apiVersion: v1
kind: Service
metadata:
  name: auth
spec:
  ports:
    - name: "5554"
      port: 5554
      targetPort: 5554

---
apiVersion: v1
kind: Service
metadata:
  name: cart
spec:
  ports:
    - name: "5560"
      port: 5560
      targetPort: 5560

---
apiVersion: v1
kind: Service
metadata:
  name: core
spec:
  ports:
    - name: "5550"
      port: 5550
      targetPort: 5550

---
apiVersion: v1
kind: Service
metadata:
  name: db
spec:
  ports:
    - name: "5555"
      port: 5555
      targetPort: 5555

---
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  ports:
    - name: "8800"
      port: 8800
      targetPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  ports:
    - name: "8080"
      port: 8080
      targetPort: 80
    - name: "8443"
      port: 8443
      targetPort: 443

---
apiVersion: v1
kind: Service
metadata:
  name: payment
spec:
  ports:
    - name: "5570"
      port: 5570
      targetPort: 5570

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  ports:
    - name: "5432"
      port: 5432
      targetPort: 5432

---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  ports:
    - name: "6379"
      port: 6379
      targetPort: 6379

---
apiVersion: v1
kind: Service
metadata:
  name: store
spec:
  ports:
    - name: "5551"
      port: 5551
      targetPort: 5551

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: DB_SERVICE_URL
              value: http://db:5555
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5554"
            - name: JWT_SECRET
              value: JunoMolaAsiQueMasPlachanito
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
          image: ponytojas/practica_mdaw_auth_node:latest
          name: auth
          ports:
            - containerPort: 5554
              hostPort: 5554
              protocol: TCP
      hostname: auth
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cart
spec:
  replicas: 1
  template:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: AUTH_SERVICE_URL
              value: http://auth:5554
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5560"
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: STORE_SERVICE_URL
              value: http://store:5551
          image: ponytojas/practica_mdaw_cart_node:latest
          name: cart
          ports:
            - containerPort: 5560
              hostPort: 5560
              protocol: TCP
      hostname: cart
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: core
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: AUTH_SERVICE_URL
              value: http://auth:5554
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5550"
            - name: STORE_SERVICE_URL
              value: http://store:5551
          image: ponytojas/practica_mdaw_core_node:latest
          name: core
          ports:
            - containerPort: 5550
              hostPort: 5550
              protocol: TCP
      hostname: core
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: DB_HOST
              value: postgres
            - name: DB_NAME
              value: postgres
            - name: DB_PASS
              value: mysecretpassword
            - name: DB_PORT
              value: "5432"
            - name: DB_SSLMODE
              value: disable
            - name: DB_USER
              value: postgres
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5555"
          image: ponytojas/practica_mdaw_database_node:latest
          name: db
          ports:
            - containerPort: 5555
              hostPort: 5555
              protocol: TCP
      hostname: db
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: VITE_CART_BASE
              value: https://nginx/cart
            - name: VITE_CORE_BASE
              value: https://nginx/api
            - name: VITE_PAYMENT_BASE
              value: https://nginx/payment
          image: ponytojas/practica_mdaw_frontend:latest
          name: frontend
          ports:
            - containerPort: 80
              hostPort: 8800
              protocol: TCP
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - image: ponytojas/practica_mdaw_nginx:latest
          name: nginx
          ports:
            - containerPort: 80
              hostPort: 8080
              protocol: TCP
            - containerPort: 443
              hostPort: 8443
              protocol: TCP
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: AUTH_SERVICE_URL
              value: http://auth:5554
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5570"
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: STORE_SERVICE_URL
              value: http://store:5551
          image: ponytojas/practica_mdaw_payment_node:latest
          name: payment
          ports:
            - containerPort: 5570
              hostPort: 5570
              protocol: TCP
      hostname: payment
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: POSTGRES_PASSWORD
              value: mysecretpassword
            - name: POSTGRES_USER
              value: postgres
          image: ponytojas/practica_mdaw_postgres:latest
          name: postgres
          ports:
            - containerPort: 5432
              hostPort: 5432
              protocol: TCP
          volumeMounts:
            - mountPath: /var/lib/postgresql/data
              name: postgres-data
      hostname: postgres
      restartPolicy: Always
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-data

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - image: redis:7.2.4-alpine3.19
          name: redis
          ports:
            - containerPort: 6379
              hostPort: 6379
              protocol: TCP
      hostname: redis
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: store
spec:
  replicas: 1
  template:
    metadata:
    spec:
      containers:
        - securityContext:
            - allowPrivilegeEscalation: false
            - runAsNonRoot: true
            - capabilities:
                drop:
                  - ALL
        - env:
            - name: DB_SERVICE_URL
              value: http://db:5555
            - name: DEBUG
              value: "false"
            - name: HTTP_PORT
              value: "5551"
          image: ponytojas/practica_mdaw_store_node:latest
          name: store
          ports:
            - containerPort: 5551
              hostPort: 5551
              protocol: TCP
      hostname: store
      restartPolicy: Always
